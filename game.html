<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Imposter Game</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap');
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    :root {
      --primary-color: #4c51bf;
      --secondary-color: #339af0;
      --accent-color: #764ba2;
      --success-color: #2ecc71;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --info-color: #3498db;
      --purple-color: #9b59b6;
      --orange-color: #e67e22;
      --teal-color: #1abc9c;
      --pink-color: #e91e63;
      --dark-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --light-bg: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-light: #f0f0f5;
      --text-dark: #2c3e50;
    }
    body {
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      background: var(--dark-bg);
      color: var(--text-light);
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
      transition: all 0.3s ease;
      position: relative;
    }
    body.light-mode {
      background: var(--light-bg);
      color: var(--text-dark);
    }
    /* Header */
    .header {
      width: 100%;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--glass-border);
      position: fixed;
      top: 0;
      z-index: 1000;
    }
    .logo {
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .theme-toggle, .sound-toggle {
      padding: 8px 16px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 25px;
      color: inherit;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    .theme-toggle:hover, .sound-toggle:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
    }
    /* Main Container */
    .main-container {
      margin-top: 100px;
      width: 100%;
      max-width: 1200px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    /* Pass Device Screen */
    .pass-device-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--dark-bg);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      text-align: center;
    }
    .pass-device-content {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 25px;
      padding: 60px;
      max-width: 600px;
      width: 90%;
    }
    .pass-device-title {
      font-size: 3rem;
      font-weight: 800;
      margin-bottom: 30px;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .pass-device-message {
      font-size: 1.5rem;
      margin-bottom: 40px;
      line-height: 1.6;
    }
    .countdown-display {
      font-size: 4rem;
      font-weight: 800;
      color: var(--warning-color);
      margin: 30px 0;
    }
    /* Game Setup Screen */
    .setup-screen {
      text-align: center;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 25px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      max-width: 800px;
      width: 100%;
    }
    .game-title {
      font-size: 3rem;
      font-weight: 800;
      margin-bottom: 20px;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    /* Tab Navigation */
    .tab-navigation {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
      border-bottom: 1px solid var(--glass-border);
    }
    .tab-button {
      padding: 12px 24px;
      background: none;
      border: none;
      color: inherit;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    .tab-button:hover {
      color: var(--secondary-color);
    }
    .tab-button.active {
      color: var(--secondary-color);
    }
    .tab-button.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 3px;
      background: var(--secondary-color);
      border-radius: 3px 3px 0 0;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .setup-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 30px 0;
    }
    .setup-item {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .setup-item label {
      font-weight: 600;
      font-size: 1.1rem;
    }
    .setup-item select, .setup-item input {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      background: var(--glass-bg);
      color: inherit;
      font-size: 1rem;
      font-weight: 500;
      backdrop-filter: blur(10px);
    }
    /* Role Options - Updated for multiple roles */
    .role-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .role-option {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 15px;
      background: var(--glass-bg);
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      transition: all 0.3s ease;
    }
    .role-option:hover {
      background: var(--primary-color);
      transform: translateY(-2px);
    }
    .role-option-header {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
    }
    .role-option-description {
      font-size: 0.85rem;
      opacity: 0.8;
      margin-bottom: 8px;
    }
    .role-option-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .role-quantity {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .role-quantity button {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      background: var(--secondary-color);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .role-quantity button:hover {
      background: var(--primary-color);
      transform: scale(1.1);
    }
    .role-quantity input {
      width: 40px;
      text-align: center;
      border-radius: 6px;
      border: 1px solid var(--glass-border);
      background: var(--glass-bg);
      color: inherit;
      font-weight: 600;
    }
    .role-team-indicator {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .team-innocent {
      background: rgba(46, 204, 113, 0.2);
      color: var(--success-color);
    }
    .team-imposter {
      background: rgba(231, 76, 60, 0.2);
      color: var(--danger-color);
    }
    .team-neutral {
      background: rgba(243, 156, 18, 0.2);
      color: var(--warning-color);
    }
    .start-game-btn {
      padding: 20px 60px;
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      border: none;
      border-radius: 50px;
      color: white;
      cursor: pointer;
      margin-top: 30px;
      box-shadow: 0 10px 30px rgba(76, 81, 191, 0.4);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .start-game-btn:hover:not(:disabled) {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(76, 81, 191, 0.6);
    }
    .start-game-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    /* Game Screen */
    .game-screen {
      width: 100%;
      max-width: 1200px;
      display: none;
    }
    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      background: var(--glass-bg);
      padding: 20px;
      border-radius: 20px;
      backdrop-filter: blur(20px);
    }
    .game-info {
      display: flex;
      gap: 30px;
      align-items: center;
    }
    .player-count, .phase-indicator {
      font-weight: 600;
      font-size: 1.2rem;
    }
    .timer {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--warning-color);
      min-width: 80px;
    }
    /* Role Display */
    .role-display {
      background: var(--glass-bg);
      border-radius: 20px;
      padding: 40px;
      margin: 20px 0;
      text-align: center;
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.5s ease;
    }
    .role-display.show {
      opacity: 1;
      transform: translateY(0);
    }
    .category-display {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--info-color);
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .word-display {
      font-size: 3rem;
      font-weight: 800;
      color: var(--success-color);
      margin: 20px 0;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      letter-spacing: 2px;
    }
    .role-name {
      font-size: 2.5rem;
      font-weight: 800;
      margin: 20px 0;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    /* Role Colors */
    .role-name.imposter { color: var(--danger-color); }
    .role-name.mayor { color: #ffd700; }
    .role-name.jester { color: #f200ff; }
    .role-name.observer { color: #00e5ff; }
    .role-name.protector { color: var(--success-color); }
    .role-name.detective { color: var(--purple-color); }
    .role-name.medic { color: var(--teal-color); }
    .role-name.shapeshifter { color: var(--orange-color); }
    .role-name.bodyguard { color: #2c3e50; }
    .role-name.psychic { color: var(--pink-color); }
    .role-name.hinter { color: #8a2be2; }
    .role-name.saboteur { color: #ff4500; }
    .role-name.executioner { color: #4b0082; }
    .role-name.lawyer { color: #daa520; }
    .role-name.silencer { color: #ff0000; }
    .role-name.host { color: #583b31; }
    /* Special Actions - Updated for player grid */
    .special-actions {
      background: var(--glass-bg);
      border-radius: 20px;
      padding: 25px;
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      margin: 20px 0;
    }
    .action-header {
      text-align: center;
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 20px;
    }
    .player-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .player-action-btn {
      padding: 15px 10px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80px;
      position: relative;
    }
    .player-action-btn.primary { background: var(--primary-color); color: white; }
    .player-action-btn.success { background: var(--success-color); color: white; }
    .player-action-btn.danger { background: var(--danger-color); color: white; }
    .player-action-btn.warning { background: var(--warning-color); color: white; }
    .player-action-btn.purple { background: var(--purple-color); color: white; }
    .player-action-btn.teal { background: var(--teal-color); color: white; }
    .player-action-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    .player-action-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .player-action-btn .player-number {
      font-size: 1.2rem;
      font-weight: 800;
      margin-bottom: 5px;
    }
    .player-action-btn .player-status {
      font-size: 0.75rem;
      opacity: 0.8;
    }
    .player-action-btn.used::after {
      content: '✓';
      position: absolute;
      top: 5px;
      right: 5px;
      background: var(--success-color);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
    }
    /* Voting System */
    .voting-container {
      background: var(--glass-bg);
      border-radius: 20px;
      padding: 30px;
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      margin: 20px 0;
    }
    .voting-header {
      text-align: center;
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 30px;
      color: var(--danger-color);
    }
    .voting-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .vote-option {
      padding: 20px;
      background: var(--glass-bg);
      border: 2px solid var(--glass-border);
      border-radius: 15px;
      cursor: pointer;
      text-align: center;
      font-weight: 600;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      position: relative;
    }
    .vote-option:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    .vote-option.selected {
      background: var(--danger-color);
      color: white;
      border-color: var(--danger-color);
    }
    .vote-option.silenced {
      opacity: 0.5;
      pointer-events: none;
    }
    /* Player Status */
    .players-status {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .player-card {
      background: var(--glass-bg);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      transition: all 0.3s ease;
      position: relative;
    }
    .player-card.eliminated {
      opacity: 0.5;
      background: var(--danger-color);
    }
    .player-card.protected {
      border: 2px solid var(--success-color);
      box-shadow: 0 0 20px rgba(46, 204, 113, 0.3);
    }
    .player-card.current-turn {
      border: 2px solid var(--warning-color);
      box-shadow: 0 0 20px rgba(243, 156, 18, 0.3);
      animation: pulse 2s infinite;
    }
    .player-card.silenced {
      border: 2px solid #696969;
      box-shadow: 0 0 20px rgba(105, 105, 105, 0.3);
    }
    .player-card.sabotaged {
      border: 2px solid var(--warning-color);
      box-shadow: 0 0 20px rgba(243, 156, 18, 0.3);
    }
    .player-number {
      font-size: 1.5rem;
      font-weight: 800;
      margin-bottom: 10px;
    }
    .player-status {
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    /* Win Screen - FIXED FOR SCROLLING */
    .win-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--dark-bg);
      display: none;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      z-index: 3000;
      text-align: center;
      overflow-y: auto;
      padding: 20px 0;
    }
    .win-content {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 25px;
      padding: 40px;
      max-width: 800px;
      width: 90%;
      margin: 20px 0;
      min-height: auto;
    }
    .win-title {
      font-size: 3.5rem;
      font-weight: 800;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 3px;
    }
    .role-reveal-section {
      margin: 20px 0;
      padding: 20px;
      background: var(--glass-bg);
      border-radius: 15px;
      border: 1px solid var(--glass-border);
      max-height: none;
    }
    .role-reveal-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--info-color);
    }
    .player-role-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      margin: 5px 0;
      background: var(--glass-bg);
      border-radius: 10px;
      border: 1px solid var(--glass-border);
    }
    .player-role-item.imposter {
      background: rgba(231, 76, 60, 0.2);
      border-color: var(--danger-color);
    }
    .player-role-item.innocent {
      background: rgba(46, 204, 113, 0.2);
      border-color: var(--success-color);
    }
    /* Animations */
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    .pulse { animation: pulse 2s infinite; }
    .shake { animation: shake 0.5s ease-in-out; }
    /* Responsive Design */
    @media (max-width: 768px) {
      .main-container { padding: 10px; }
      .setup-grid { grid-template-columns: 1fr; }
      .game-header { flex-direction: column; gap: 15px; }
      .game-info { flex-direction: column; gap: 10px; }
      .action-buttons { flex-direction: column; }
      .game-title { font-size: 2rem; }
      .start-game-btn { padding: 15px 40px; font-size: 1.5rem; }
      .pass-device-content { padding: 40px 20px; }
      .pass-device-title { font-size: 2rem; }
      .win-title { font-size: 2.5rem; }
      .win-content { padding: 30px 20px; }
      .role-options { grid-template-columns: 1fr; }
      .player-grid { grid-template-columns: repeat(3, 1fr); }
    }
    /* Hidden elements */
    .hidden { display: none !important; }
    /* Notification System */
    .notification {
      position: fixed;
      top: 120px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      z-index: 1001;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 300px;
    }
    .notification.show { transform: translateX(0); }
    .notification.success { background: var(--success-color); }
    .notification.error { background: var(--danger-color); }
    .notification.warning { background: var(--warning-color); }
    .notification.info { background: var(--info-color); }
    /* Sound Visualization */
    .sound-visualizer {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: 2px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 999;
    }
    .sound-visualizer.active {
      opacity: 1;
      animation: pulse 0.5s ease;
    }
    /* Improved Difficulty Buttons */
    .difficulty-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 10px;
    }
    .difficulty-btn {
      padding: 12px 25px;
      border: none;
      border-radius: 30px;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    .difficulty-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }
    .difficulty-btn:hover::before {
      transform: translateX(0);
    }
    .easy-btn {
      background: linear-gradient(45deg, #56ab2f, #a8e063);
      color: white;
    }
    .easy-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(86, 171, 47, 0.4);
    }
    .hard-btn {
      background: linear-gradient(45deg, #e53935, #e35d5b);
      color: white;
    }
    .hard-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(229, 57, 53, 0.4);
    }
    .difficulty-label {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 10px;
    }
  </style>
</head>
<body class="dark-mode">
  <!-- Header -->
  <div class="header">
    <div class="logo">🕵️</div>
    <div class="header-controls">
      <button class="sound-toggle" onclick="toggleSound()">🔊 Sound: ON</button>
      <button class="theme-toggle" onclick="toggleTheme()">🌙 Dark Mode</button>
    </div>
  </div>
  <!-- Pass Device Screen -->
  <div id="passDeviceScreen" class="pass-device-screen">
    <div class="pass-device-content">
      <div class="pass-device-title" id="passDeviceTitle">Pass Device</div>
      <div class="pass-device-message" id="passDeviceMessage">
        Hand the device to Player 1 and press continue when ready.
      </div>
      <div class="countdown-display" id="countdownDisplay"></div>
      <div class="action-buttons">
        <button class="action-btn success" onclick="continueToRole()" id="continueBtn">
          ✅ I'm Ready
        </button>
        <button class="action-btn warning" onclick="showCountdown()" id="countdownBtn">
          ⏱️ Start Countdown
        </button>
      </div>
    </div>
  </div>
  <!-- Win Screen -->
  <div id="winScreen" class="win-screen">
    <div class="win-content">
      <div id="winTitle" class="win-title">IMPOSTERS WIN!</div>
      <div id="winMessage" style="font-size: 1.5rem; margin-bottom: 30px;"></div>
      
      <div class="role-reveal-section">
        <div class="role-reveal-title">🎭 Role Reveals</div>
        <div id="roleRevealList"></div>
      </div>
      
      <div class="action-buttons" style="margin-top: 30px;">
        <button class="action-btn primary" onclick="playAgain()">🔄 Play Again</button>
        <button class="action-btn success" onclick="backToMenu()">🏠 Main Menu</button>
      </div>
    </div>
  </div>
  <!-- Main Container -->
  <div class="main-container">
    <!-- Game Setup Screen -->
    <div id="setupScreen" class="setup-screen">
      <h1 class="game-title">IMPOSTER GAME</h1>
      <p style="font-size: 1.2rem; margin-bottom: 30px; opacity: 0.8;">
        🎮 Pass-and-Play Social Deduction Game
      </p>
      
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button class="tab-button active" onclick="switchTab('settings')">Game Settings</button>
        <button class="tab-button" onclick="switchTab('roles')">Special Roles</button>
      </div>
      
      <!-- Settings Tab -->
      <div id="settingsTab" class="tab-content active">
        <div class="setup-grid">
          <div class="setup-item">
            <label for="playerCount">Number of Players:</label>
            <select id="playerCount" onchange="updatePlayerCountOptions()">
              <option value="4">4 Players</option>
              <option value="5" selected>5 Players</option>
              <option value="6">6 Players</option>
              <option value="7">7 Players</option>
              <option value="8">8 Players</option>
              <option value="9">9 Players</option>
              <option value="10">10 Players</option>
              <option value="12">12 Players</option>
            </select>
          </div>
          <div class="setup-item">
            <label for="imposterCount">Number of Imposters:</label>
            <select id="imposterCount" onchange="updateSetupDisplay()">
              <option value="1" selected>1 Imposter</option>
              <option value="2">2 Imposters</option>
              <option value="3">3 Imposters</option>
            </select>
          </div>
          <div class="setup-item">
            <label for="discussionTime">Discussion Time (minutes):</label>
            <select id="discussionTime">
              <option value="3" selected>3 Minutes</option>
              <option value="5">5 Minutes</option>
              <option value="7">7 Minutes</option>
              <option value="10">10 Minutes</option>
              <option value="15">15 Minutes</option>
            </select>
          </div>
          <div class="setup-item">
            <label for="gameMode">Game Mode:</label>
            <select id="gameMode">
              <option value="classic" selected>Classic Mode</option>
              <option value="chaos">Chaos Mode (More Roles)</option>
              <option value="mystery">Mystery Mode</option>
              <option value="speed">Speed Mode</option>
            </select>
          </div>
          <div class="setup-item">
            <div class="difficulty-label">Choose Difficulty:</div>
            <div class="difficulty-buttons">
              <button class="difficulty-btn easy-btn" onclick="setDifficulty('easy')">🌱 Easy</button>
              <button class="difficulty-btn hard-btn" onclick="setDifficulty('hard')">🔥 Gen Z</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Roles Tab -->
      <div id="rolesTab" class="tab-content">
        <div class="role-options" id="roleOptions">
          <!-- Roles will be dynamically added here -->
        </div>
      </div>
      
      <button class="start-game-btn" onclick="startGame()" id="startGameBtn">
        🚀 START GAME
      </button>
    </div>
    <!-- Game Screen -->
    <div id="gameScreen" class="game-screen">
      <div class="game-header">
        <div class="game-info">
          <div class="player-count" id="playerCountDisplay">Players: 5</div>
          <div class="phase-indicator" id="phaseIndicator">Role Assignment</div>
        </div>
        <div class="timer" id="gameTimer">--:--</div>
      </div>
      <!-- Role Display -->
      <div id="roleDisplay" class="role-display">
        <div class="category-display" id="categoryDisplay"></div>
        <div class="word-display" id="wordDisplay"></div>
        <div class="role-name" id="roleName"></div>
        <div id="roleDescription" style="margin-top: 20px; font-size: 1.1rem; opacity: 0.8;"></div>
      </div>
      <!-- Special Actions -->
      <div id="specialActions" class="special-actions hidden">
        <h3 class="action-header" id="actionHeader">Special Actions Available</h3>
        <div class="player-grid" id="playerGrid"></div>
        <div class="action-buttons" id="actionButtons"></div>
      </div>
      <!-- Voting Container -->
      <div id="votingContainer" class="voting-container hidden">
        <div class="voting-header" id="votingHeader">Vote to Eliminate</div>
        <div class="voting-grid" id="votingGrid"></div>
        <div class="action-buttons">
          <button class="action-btn danger" onclick="submitVote()" id="submitVoteBtn" disabled>
            🗳️ Submit Vote
          </button>
          <button class="action-btn warning" onclick="skipVote()" id="skipVoteBtn">
            ⏭️ Skip Vote
          </button>
        </div>
      </div>
      <!-- Players Status -->
      <div class="players-status" id="playersStatus"></div>
      <!-- Game Controls -->
      <div class="action-buttons" style="margin-top: 30px;">
        <button class="action-btn primary" onclick="nextPhase()" id="nextPhaseBtn">
          ➡️ Next Player
        </button>
        <button class="action-btn warning" onclick="endGame()" id="endGameBtn">
          🏁 End Game
        </button>
      </div>
    </div>
  </div>
  <!-- Notification Container -->
  <div id="notificationContainer"></div>
  <!-- Sound Visualizer -->
  <div id="soundVisualizer" class="sound-visualizer">🔊</div>
  <script>
    // Game State Variables
    let gameState = {
      players: [],
      currentPlayer: 0,
      phase: 'setup', // setup, roles, discussion, voting, night, gameOver
      timer: null,
      timeRemaining: 0,
      votingResults: {},
      selectedVote: null,
      gameSettings: {
        playerCount: 5,
        imposterCount: 1,
        discussionTime: 3,
        gameMode: 'classic',
        enabledRoles: {}
      },
      eliminatedPlayers: [],
      protectedPlayers: [],
      silencedPlayers: [],
      sabotagedPlayers: [],
      specialActions: {},
      gameHistory: [],
      currentWord: '',
      currentCategory: ''
    };
    // Sound settings
    let soundEnabled = true;
    let currentTheme = 'dark';
    
    const easyWordCategories = {
      Animals: [ "Whale", "Pelican", "Emu", "Lion", "Wolf", "Shark", "Bee", "Bunny", "Cat", "Bird", "Kangaroo", "Fish", "Dog"],
      Fruits: ["Plum", "Apricot", "Mango", "Apple", "Pear", "Watermelon", "Passionfruit", "Banana", "Grape", "Pineapple", "Orange", "Strawberry", "Rasberry"],
      Jobs: ["Teacher", "Garbage Man", "Singer", "Dancer", "Scientist", "FireFighter", "Bus Driver", "Dentist", "Doctor", "Vet", "Artist", "Chef"],
      Songs: ["Baby Shark", "Twinkle Twinkle", "Happy Birthday", "Wheels on the Bus", "Let it go", "Last Christmas", "This Old Man", "Happy", "Old MacDonald", "Friday", "Hockey Pokey", "Jingle Bells"],
      Instruments: ["Guitar", "Violin", "Piano", "Cowbell", "Microphone", "Flute", "Drums", "Recorder", "Keyboard"],
      "Super-Heroes": ["Superman", "Batman", "Catwoman", "Spiderman", "Hulk", "Iron Man", "Wonder-Woman", "Wolverine", "Mario", "Moana", "Elastigirl", "Elsa"],
      Movies: ["Toy Story", "Frozen", "Moana", "Cinderalla", "Snow White", "Incredibles", "Cars", "Up", "Kung fu Panda", "Rio", "Inside Out", "Big Hero 6"],
      "Parts of body": ["Nose", "Eye", "Leg", "Arm", "Hand", "Foot", "Head", "Ear", "Mouth", "Back", "Hair", "Fingers", "Teeth", "Toes", "Brain", "Heart"],
      Pets: ["Dog", "Cat", "Fish", "Rabbit", "Hamster", "Bird", "Turtle", "Guinea Pig", "Frog", "Lizard"],
      Clothing: ["Shirt", "Pants", "Hat", "Jacket", "Socks", "Shoes", "Gloves", "Scarf", "Dress", "Shorts"],
    };
    const hardWordCategories = {
      Animals: ["Coyote", "Hyena", "Whale", "Otter", "Pelican", "Emu", "Lion", "Wolf", "Shark", "Bee", "Bunny", "Bobcat", "Cat", "Dodo Bird", "Kangaroo"],
      Fruits: ["Plum", "Apricot", "Mango", "Apple", "Pear", "Watermelon", "Passionfruit", "Dragonfruit", "Banana", "Grape", "Pineapple", "Orange", "Strawberry"],
      Jobs: ["Teacher", "Animator", "Construction Worker", "Dancer", "Photographer", "Logistician", "Bus Driver", "Plumber", "Doctor", "Tax Auditor", "President", "Dentist"],
      Songs: ["Shake it off", "Baby", "Not like us", "Despacito", "Shape of you", "Uptown Funk", "Payphone", "Hello", "Dream on", "Gods Plan", "Stiches", "Drivers License", "Thriller"],
      Instruments: ["Guitar", "Violin", "Harmonica", "Piano", "Ukulele", "Cowbell", "Didgeridoo", "The Triangle", "Microphone", "Flute", "Kick Drum", "Accordion"],
      Countries: ["Slovenia", "Moldova", "Bhutan", "New Zealand", "USA", "Argentina", "Mexico", "Brazil", "Comoros", "France", "Germany", "Canada"],
      "Famous People": ["Michael Jackson", "Timothee Chalamet", "Ariana Grande", "Lebron James", "Chris Pratt", "Jim Carrey", "Chris Rock", "Elon Musk", "The Rock", "John Cena", "Martin Luther King", "Kanye West"],
      "Video Games": ["Fortnite", "Minecraft", "Call of Duty", "Tertis", "Among Us", "Halo", "Fall Guys", "Fifa", "NBA 2K", "Pac-Man"],
      Athletes: ["Luka Doncic", "Steph Curry", "Klay Thompson", "Tiger Woods", "Ronaldo", "Kawhi Leonard", "Messi", "Travis Kelce", "Kylian Mbappe", "Caitlin Clark", "Angel Reese", "Rory Mcilroy"],
      Movies: ["Toy Story", "Shawshank Redemption", "Daddy's Home", "End Game", "Titanic", "Incredibles", "Charlotte's Web", "Iron Man", "Frozen", "Fast and Furious", "Inside Out", "BIG"],
      Foods: ["Spaghetti Bolognese", "Taco", "Risotto", "Steak", "Jelly", "Jollof Rice", "Egg Fried Rice", "Sushi", "Pork", "Ribs", "Ratatouille", "Chicken Noodle Soup", "Massaman Beef Curry"],
      "Super-Heroes": ["Superman", "Batman", "Catwoman", "Spiderman", "Hulk", "Iron Man", "Deadpool", "Wolverine", "Mario", "Captain America", "Elastigirl", "Frozone"],
      Brands: ["Nike", "Team 10", "Vans", "Reebok", "Fifa", "Google", "Apple", "Adidas", "Victoria's Secret", "McDonald's", "Faze", "Hype House", "Bop House"],
      Villans: ["Joker", "Uma", "Thanos", "Harely Quinn", "Bane", "Green Goblen", "Lex Luther", "Mysterio", "Prowler", "King Pin", "Omni Man", "Loki", "Darth Vader", "Voldemort", "Ghost Face", "Chucky", "PennyWise"],
    };
    // Default to easy
    let currentWordCategories = easyWordCategories;
    
    // Word hints
    const wordHints = {
      // Animals
      "Whale": "Large marine mammal",
      "Pelican": "Bird with a distinctive beak pouch",
      "Emu": "Flightless bird from Australia",
      "Lion": "Large wild cat with a mane",
      "Wolf": "Wild canine that lives in packs",
      "Shark": "Ocean predator with cartilage skeleton",
      "Bee": "Insect that produces sweet substances",
      "Bunny": "Small mammal with long ears",
      "Cat": "Domestic feline pet",
      "Bird": "Flying vertebrate with feathers",
      "Kangaroo": "Marsupial that hops",
      "Fish": "Aquatic vertebrate with gills",
      "Dog": "Domestic canine companion",
      "Coyote": "Wild canine found in North America",
      "Hyena": "African carnivore with a distinctive call",
      "Otter": "Semi-aquatic mammal known for playfulness",
      "Bobcat": "North American wild feline",
      "Dodo Bird": "Extinct flightless bird from an island",
      
      // Fruits
      "Plum": "Small stone fruit with purple skin",
      "Apricot": "Small orange stone fruit",
      "Mango": "Tropical fruit with orange flesh",
      "Apple": "Common round fruit",
      "Pear": "Bell-shaped fruit with juicy flesh",
      "Watermelon": "Large green fruit with watery red flesh",
      "Passionfruit": "Tropical fruit with pulpy interior",
      "Banana": "Yellow curved fruit",
      "Grape": "Small fruit that grows in clusters",
      "Pineapple": "Tropical fruit with a crown",
      "Orange": "Citrus fruit",
      "Strawberry": "Red berry with seeds on outside",
      "Rasberry": "Red composite berry",
      "Dragonfruit": "Exotic fruit with striking appearance",
      
      // Jobs
      "Teacher": "Educator in a learning environment",
      "Garbage Man": "Worker who collects waste",
      "Singer": "Vocal performer",
      "Dancer": "Performer who expresses through movement",
      "Scientist": "Researcher in a field of study",
      "FireFighter": "Emergency responder for fires",
      "Bus Driver": "Operator of a large road vehicle",
      "Dentist": "Professional who treats oral health",
      "Doctor": "Medical practitioner",
      "Vet": "Animal healthcare provider",
      "Artist": "Creator of visual or performance works",
      "Chef": "Professional cook",
      "Animator": "Creator of moving images",
      "Construction Worker": "Builder of structures",
      "Photographer": "Creator of images using a camera",
      "Logistician": "Manager of supply chains",
      "Plumber": "Worker who deals with water systems",
      "Tax Auditor": "Financial records examiner",
      "President": "Leader of a nation",
      
      // Songs
      "Baby Shark": "Children's song about sea creatures",
      "Twinkle Twinkle": "Nursery rhyme about celestial bodies",
      "Happy Birthday": "Song for celebrating birth anniversaries",
      "Wheels on the Bus": "Children's song about transportation",
      "Let it go": "Song about releasing inhibitions",
      "Last Christmas": "Song about a past holiday relationship",
      "This Old Man": "Children's counting song",
      "Happy": "Song about positive emotions",
      "Old MacDonald": "Children's song about farm animals",
      "Friday": "Song about the end of the work week",
      "Hockey Pokey": "Children's dance song",
      "Jingle Bells": "Winter holiday song",
      "Shake it off": "Song about ignoring negativity",
      "Baby": "Song about romantic affection",
      "Not like us": "Song about differences",
      "Despacito": "Popular Spanish-language song",
      "Shape of you": "Song about physical attraction",
      "Uptown Funk": "Upbeat song about style",
      "Payphone": "Song about trying to reconnect",
      "Hello": "Song about reaching out",
      "Dream on": "Song about aspirations",
      "Gods Plan": "Song about destiny",
      "Stiches": "Song about emotional pain",
      "Drivers License": "Song about driving and heartbreak",
      "Thriller": "Song with spooky elements",
      
      // Instruments
      "Guitar": "String instrument with frets",
      "Violin": "String instrument played with a bow",
      "Piano": "Instrument with black and white keys",
      "Cowbell": "Percussion instrument from a farm animal",
      "Microphone": "Device that amplifies sound",
      "Flute": "Woodwind instrument",
      "Drums": "Percussion instrument",
      "Recorder": "Small wind instrument",
      "Keyboard": "Electronic instrument with keys",
      "Harmonica": "Small mouth-blown reed instrument",
      "Ukulele": "Small four-stringed instrument",
      "Didgeridoo": "Long wooden wind instrument",
      "The Triangle": "Three-sided percussion instrument",
      "Kick Drum": "Large drum operated by foot",
      "Accordion": "Instrument with bellows and keys",
      
      // Super Heroes
      "Superman": "Hero with super strength and flight",
      "Batman": "Hero without superpowers",
      "Catwoman": "Feline-themed character",
      "Spiderman": "Hero with spider-like abilities",
      "Hulk": "Hero with incredible strength",
      "Iron Man": "Hero in a powered suit",
      "Wonder-Woman": "Amazonian princess hero",
      "Wolverine": "Hero with healing abilities",
      "Mario": "Plumber hero in video games",
      "Moana": "Polynesian heroine",
      "Elastigirl": "Hero with stretching abilities",
      "Elsa": "Hero with ice powers",
      
      // Movies
      "Toy Story": "Film about toys coming to life",
      "Frozen": "Film about two royal sisters",
      "Moana": "Film about a Polynesian journey",
      "Cinderalla": "Film about a mistreated girl",
      "Snow White": "Film about a princess and dwarfs",
      "Incredibles": "Film about a superhero family",
      "Cars": "Film about talking vehicles",
      "Up": "Film about a flying house",
      "Kung fu Panda": "Film about a martial arts animal",
      "Rio": "Film about a tropical bird",
      "Inside Out": "Film about personified emotions",
      "Big Hero 6": "Film about a boy and his robot",
      "Shawshank Redemption": "Film about hope in prison",
      "Daddy's Home": "Comedy about stepfamilies",
      "End Game": "Superhero conclusion film",
      "Titanic": "Film about a famous ship disaster",
      "Charlotte's Web": "Film about a friendship between animals",
      "Fast and Furious": "Film about street racing",
      "BIG": "Film about a child in an adult body",
      
      // Parts of body
      "Nose": "Facial feature for smelling",
      "Eye": "Organ for vision",
      "Leg": "Lower limb for walking",
      "Arm": "Upper limb with hands",
      "Hand": "Body part with digits",
      "Foot": "Lower body part with toes",
      "Head": "Top part of the body",
      "Ear": "Organ for hearing",
      "Mouth": "Facial feature for eating",
      "Back": "Rear part of the torso",
      "Hair": "Grows on the scalp",
      "Fingers": "Digits on the hand",
      "Teeth": "Used for chewing",
      "Toes": "Digits on the foot",
      "Brain": "Organ in the head",
      "Heart": "Organ that pumps blood",
      
      // Pets
      "Dog": "Common domestic canine",
      "Cat": "Common domestic feline",
      "Fish": "Aquatic pet",
      "Rabbit": "Small mammal with long ears",
      "Hamster": "Small rodent pet",
      "Bird": "Feathered pet",
      "Turtle": "Reptile with a shell",
      "Guinea Pig": "Small rodent pet",
      "Frog": "Amphibian pet",
      "Lizard": "Reptile pet",
      
      // Clothing
      "Shirt": "Upper body garment",
      "Pants": "Lower body garment",
      "Hat": "Head covering",
      "Jacket": "Outerwear garment",
      "Socks": "Foot coverings",
      "Shoes": "Footwear",
      "Gloves": "Hand coverings",
      "Scarf": "Neck covering",
      "Dress": "One-piece garment",
      "Shorts": "Short trousers",
      
      // Countries
      "Slovenia": "European country",
      "Moldova": "Eastern European country",
      "Bhutan": "Himalayan country",
      "New Zealand": "Island country in Pacific",
      "USA": "North American country",
      "Argentina": "South American country",
      "Mexico": "North American country",
      "Brazil": "South American country",
      "Comoros": "Island nation in Indian Ocean",
      "France": "Western European country",
      "Germany": "Central European country",
      "Canada": "North American country",
      
      // Famous People
      "Michael Jackson": "King of Pop",
      "Timothee Chalamet": "Young American actor",
      "Ariana Grande": "American pop singer",
      "Lebron James": "Basketball player",
      "Chris Pratt": "American actor",
      "Jim Carrey": "Canadian comedian actor",
      "Chris Rock": "American comedian",
      "Elon Musk": "Technology entrepreneur",
      "The Rock": "Wrestler turned actor",
      "John Cena": "Wrestler and actor",
      "Martin Luther King": "Civil rights leader",
      "Kanye West": "Rapper and designer",
      
      // Video Games
      "Fortnite": "Battle royale game",
      "Minecraft": "Block-building game",
      "Call of Duty": "First-person shooter game",
      "Tertis": "Block-stacking puzzle game",
      "Among Us": "Social deduction game",
      "Halo": "Sci-fi shooter game",
      "Fall Guys": "Obstacle course game",
      "Fifa": "Soccer simulation game",
      "NBA 2K": "Basketball simulation game",
      "Pac-Man": "Classic arcade game",
      
      // Athletes
      "Luka Doncic": "Basketball player",
      "Steph Curry": "Basketball player",
      "Klay Thompson": "Basketball player",
      "Tiger Woods": "Golfer",
      "Ronaldo": "Soccer player",
      "Kawhi Leonard": "Basketball player",
      "Messi": "Soccer player",
      "Travis Kelce": "Football player",
      "Kylian Mbappe": "Soccer player",
      "Caitlin Clark": "Basketball player",
      "Angel Reese": "Basketball player",
      "Rory Mcilroy": "Golfer",
      
      // Foods
      "Spaghetti Bolognese": "Italian pasta dish",
      "Taco": "Mexican dish",
      "Risotto": "Italian rice dish",
      "Steak": "Cooked meat",
      "Jelly": "Fruit spread",
      "Jollof Rice": "West African rice dish",
      "Egg Fried Rice": "Asian rice dish",
      "Sushi": "Japanese rice dish",
      "Pork": "Meat from pigs",
      "Ribs": "Meat dish",
      "Ratatouille": "French vegetable dish",
      "Chicken Noodle Soup": "Soup dish",
      "Massaman Beef Curry": "Thai curry dish",
      
      // Brands
      "Nike": "Sportswear company",
      "Team 10": "Social media group",
      "Vans": "Shoe company",
      "Reebok": "Sportswear company",
      "Fifa": "Soccer organization",
      "Google": "Technology company",
      "Apple": "Technology company",
      "Adidas": "Sportswear company",
      "Victoria's Secret": "Lingerie brand",
      "McDonald's": "Fast food chain",
      "Faze": "Esports organization",
      "Hype House": "Social media collective",
      "Bop House": "Social media collective",
      
      // Villans
      "Joker": "Batman's nemesis",
      "Uma": "Disney villain",
      "Thanos": "Marvel villain",
      "Harely Quinn": "Batman villain",
      "Bane": "Batman villain",
      "Green Goblen": "Spiderman villain",
      "Lex Luther": "Superman villain",
      "Mysterio": "Spiderman villain",
      "Prowler": "Spiderman villain",
      "King Pin": "Spiderman villain",
      "Omni Man": "Invincible villain",
      "Loki": "Marvel villain",
      "Darth Vader": "Star Wars villain",
      "Voldemort": "Harry Potter villain",
      "Ghost Face": "Scream villain",
      "Chucky": "Horror doll villain",
      "PennyWise": "Horror clown villain"
    };
    
    // Role definitions with enhanced descriptions
    const roles = {
      innocent: {
        name: 'Innocent',
        description: 'You know the secret word. Find the imposters!',
        team: 'innocent',
        actions: []
      },
      imposter: {
        name: 'Imposter',
        description: 'You don\'t know the word. Blend in and avoid detection!',
        team: 'imposter',
        actions: []
      },
      mayor: {
        name: 'Mayor',
        description: 'Your vote counts double during elimination rounds.',
        team: 'innocent',
        actions: ['doubleVote']
      },
      jester: {
        name: 'Jester',
        description: 'Win by getting yourself voted out!',
        team: 'neutral',
        actions: []
      },
      observer: {
        name: 'Observer',
        description: 'Once per game, you can see another player\'s role.',
        team: 'innocent',
        actions: ['observe']
      },
      protector: {
        name: 'Protector',
        description: 'Protect one player from elimination each round.',
        team: 'innocent',
        actions: ['protect']
      },
      detective: {
        name: 'Detective',
        description: 'Investigate players to learn if they\'re suspicious.',
        team: 'innocent',
        actions: ['investigate']
      },
      medic: {
        name: 'Medic',
        description: 'Bring back one eliminated player per game.',
        team: 'innocent',
        actions: ['heal']
      },
      shapeshifter: {
        name: 'Shapeshifter',
        description: 'Copy another player\'s special abilities.',
        team: 'imposter',
        actions: ['shapeshift']
      },
      bodyguard: {
        name: 'Bodyguard',
        description: 'Shield a target from all negative effects.',
        team: 'innocent',
        actions: ['shield']
      },
      psychic: {
        name: 'Psychic',
        description: 'Receive visions about the game state.',
        team: 'innocent',
        actions: ['vision']
      },
      executioner: {
        name: 'Executioner',
        description: 'Win by eliminating your assigned target.',
        team: 'neutral',
        actions: []
      },
      lawyer: {
        name: 'Lawyer',
        description: 'Defend your imposter client. Win if they survive.',
        team: 'neutral',
        actions: ['defend']
      },
      silencer: {
        name: 'Silencer',
        description: 'Silence one player each round.',
        team: 'imposter',
        actions: ['silence']
      },
      host: {
        name: 'Host',
        description: 'Control the discussion order and flow.',
        team: 'innocent',
        actions: ['moderateDiscussion']
      },
      hinter: {
        name: 'Hinter',
        description: 'You don\'t know the word, but you know a hint for it.',
        team: 'imposter',
        actions: []
      },
      saboteur: {
        name: 'Saboteur',
        description: 'Once per game, you can block a player\'s special ability.',
        team: 'imposter',
        actions: ['sabotage']
      }
    };
    
    // Game Initialization
    function initializeGame() {
      updatePlayerCountOptions();
      updateSetupDisplay();
      initializeRoleOptions();
      resetGameState();
    }
    
    function resetGameState() {
      // Save current settings before resetting
      const savedSettings = {
        playerCount: gameState.gameSettings.playerCount,
        imposterCount: gameState.gameSettings.imposterCount,
        discussionTime: gameState.gameSettings.discussionTime,
        gameMode: gameState.gameSettings.gameMode,
        enabledRoles: {...gameState.gameSettings.enabledRoles}
      };
      
      gameState = {
        players: [],
        currentPlayer: 0,
        phase: 'setup',
        timer: null,
        timeRemaining: 0,
        votingResults: {},
        selectedVote: null,
        gameSettings: savedSettings,
        eliminatedPlayers: [],
        protectedPlayers: [],
        silencedPlayers: [],
        sabotagedPlayers: [],
        specialActions: {},
        gameHistory: [],
        currentWord: '',
        currentCategory: ''
      };
      
      // Reset UI elements
      document.getElementById('setupScreen').style.display = 'block';
      document.getElementById('gameScreen').style.display = 'none';
      document.getElementById('passDeviceScreen').style.display = 'none';
      document.getElementById('winScreen').style.display = 'none';
      
      // Update form elements to reflect saved settings
      document.getElementById('playerCount').value = savedSettings.playerCount;
      document.getElementById('imposterCount').value = savedSettings.imposterCount;
      document.getElementById('discussionTime').value = savedSettings.discussionTime;
      document.getElementById('gameMode').value = savedSettings.gameMode;
      
      // Update role quantities
      updateRoleQuantities(savedSettings.enabledRoles);
      
      // Clear any running timers
      if (gameState.timer) {
        clearInterval(gameState.timer);
        gameState.timer = null;
      }
      
      // Clear notifications
      clearNotifications();
      
      // Reset player status display
      document.getElementById('playersStatus').innerHTML = '';
      document.getElementById('votingGrid').innerHTML = '';
      document.getElementById('playerGrid').innerHTML = '';
      document.getElementById('actionButtons').innerHTML = '';
      
      showNotification('Game reset! Ready for a new game.', 'success');
    }
    
    function setDifficulty(level) {
      if (level === 'easy') {
        currentWordCategories = easyWordCategories;
        showNotification('Easy mode selected. Words are simpler and more common.', 'success');
      } else if (level === 'hard') {
        currentWordCategories = hardWordCategories;
        showNotification('Gen Z mode selected. Words are more challenging and obscure!', 'danger');
      }
    }
    
    function updatePlayerCountOptions() {
      const playerCount = parseInt(document.getElementById('playerCount').value);
      const imposterSelect = document.getElementById('imposterCount');
      const currentImposterCount = parseInt(imposterSelect.value);
      
      imposterSelect.innerHTML = '';
      const maxImposters = Math.floor(playerCount / 3);
      
      for (let i = 1; i <= maxImposters; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `${i} Imposter${i > 1 ? 's' : ''}`;
        if (i === currentImposterCount && i <= maxImposters) {
          option.selected = true;
        } else if (i === 1 && currentImposterCount > maxImposters) {
          option.selected = true;
        }
        imposterSelect.appendChild(option);
      }
      
      updateSetupDisplay();
    }
    
    function updateSetupDisplay() {
      const playerCount = parseInt(document.getElementById('playerCount').value);
      const imposterCount = parseInt(document.getElementById('imposterCount').value);
      const innocentCount = playerCount - imposterCount;
      
      document.getElementById('playerCountDisplay').textContent = `Players: ${playerCount}`;
      
      // Validate game can start
      const startBtn = document.getElementById('startGameBtn');
      if (playerCount >= 4 && imposterCount >= 1 && innocentCount >= imposterCount) {
        startBtn.disabled = false;
        startBtn.textContent = '🚀 START GAME';
      } else {
        startBtn.disabled = true;
        startBtn.textContent = '❌ Invalid Setup';
      }
    }
    
    // Initialize role options in the setup screen
    function initializeRoleOptions() {
      const roleOptionsContainer = document.getElementById('roleOptions');
      roleOptionsContainer.innerHTML = '';
      
      Object.entries(roles).forEach(([roleKey, roleData]) => {
        if (roleKey === 'innocent' || roleKey === 'imposter') return; // Skip base roles
        
        const roleOption = document.createElement('div');
        roleOption.className = 'role-option';
        roleOption.dataset.role = roleKey;
        
        const roleHeader = document.createElement('div');
        roleHeader.className = 'role-option-header';
        
        const roleIcon = document.createElement('span');
        roleIcon.textContent = getRoleIcon(roleKey);
        
        const roleName = document.createElement('span');
        roleName.textContent = roleData.name;
        
        const teamIndicator = document.createElement('span');
        teamIndicator.className = `role-team-indicator team-${roleData.team}`;
        teamIndicator.textContent = roleData.team;
        
        roleHeader.appendChild(roleIcon);
        roleHeader.appendChild(roleName);
        roleHeader.appendChild(teamIndicator);
        
        const roleDescription = document.createElement('div');
        roleDescription.className = 'role-option-description';
        roleDescription.textContent = roleData.description;
        
        const roleControls = document.createElement('div');
        roleControls.className = 'role-option-controls';
        
        const roleQuantity = document.createElement('div');
        roleQuantity.className = 'role-quantity';
        
        const decreaseBtn = document.createElement('button');
        decreaseBtn.textContent = '-';
        decreaseBtn.onclick = () => decreaseRoleQuantity(roleKey);
        
        const quantityInput = document.createElement('input');
        quantityInput.type = 'number';
        quantityInput.id = `${roleKey}Quantity`;
        quantityInput.min = '0';
        quantityInput.max = '5';
        quantityInput.value = '0';
        quantityInput.readOnly = true;
        
        const increaseBtn = document.createElement('button');
        increaseBtn.textContent = '+';
        increaseBtn.onclick = () => increaseRoleQuantity(roleKey);
        
        roleQuantity.appendChild(decreaseBtn);
        roleQuantity.appendChild(quantityInput);
        roleQuantity.appendChild(increaseBtn);
        
        roleControls.appendChild(roleQuantity);
        
        roleOption.appendChild(roleHeader);
        roleOption.appendChild(roleDescription);
        roleOption.appendChild(roleControls);
        
        roleOptionsContainer.appendChild(roleOption);
      });
    }
    
    function getRoleIcon(roleKey) {
      const roleIcons = {
        mayor: '👑',
        jester: '🃏',
        observer: '👁️',
        protector: '🛡️',
        detective: '🔍',
        medic: '❌',
        shapeshifter: '❌',
        bodyguard: '🛡️',
        psychic: '❌',
        executioner: '⚖️',
        lawyer: '⚖️',
        silencer: '🤐',
        host: '🎤',
        hinter: '🔍',
        saboteur: '🛠️'
      };
      
      return roleIcons[roleKey] || '❓';
    }
    
    function increaseRoleQuantity(roleKey) {
      const input = document.getElementById(`${roleKey}Quantity`);
      const currentValue = parseInt(input.value);
      const maxValue = parseInt(input.max);
      
      if (currentValue < maxValue) {
        input.value = currentValue + 1;
        updateEnabledRoles();
      }
    }
    
    function decreaseRoleQuantity(roleKey) {
      const input = document.getElementById(`${roleKey}Quantity`);
      const currentValue = parseInt(input.value);
      
      if (currentValue > 0) {
        input.value = currentValue - 1;
        updateEnabledRoles();
      }
    }
    
    function updateEnabledRoles() {
      gameState.gameSettings.enabledRoles = {};
      
      Object.entries(roles).forEach(([roleKey, roleData]) => {
        if (roleKey === 'innocent' || roleKey === 'imposter') return;
        
        const quantityInput = document.getElementById(`${roleKey}Quantity`);
        if (quantityInput) {
          const quantity = parseInt(quantityInput.value);
          if (quantity > 0) {
            gameState.gameSettings.enabledRoles[roleKey] = quantity;
          }
        }
      });
    }
    
    function updateRoleQuantities(enabledRoles) {
      Object.entries(enabledRoles).forEach(([roleKey, quantity]) => {
        const quantityInput = document.getElementById(`${roleKey}Quantity`);
        if (quantityInput) {
          quantityInput.value = quantity;
        }
      });
    }
    
    // Tab switching function
    function switchTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active class from all tab buttons
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      // Add active class to clicked tab button
      event.target.classList.add('active');
    }
    
    // Game Start Functions
    function startGame() {
      // Hide UI elements when game starts (with error checking)
      const elementsToHide = ['soundButton', 'lightModeButton', 'darkModeButton', 'startingLogo'];
      elementsToHide.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.style.display = 'none';
        }
      });
      
      // Update enabled roles from UI
      updateEnabledRoles();
      
      gameState.gameSettings = {
        playerCount: parseInt(document.getElementById('playerCount').value),
        imposterCount: parseInt(document.getElementById('imposterCount').value),
        discussionTime: parseInt(document.getElementById('discussionTime').value),
        gameMode: document.getElementById('gameMode').value,
        enabledRoles: gameState.gameSettings.enabledRoles
      };
      
      if (gameState.gameSettings.playerCount < 4) {
        showNotification('Need at least 4 players to start!', 'error');
        return;
      }
      
      playSound('gameStart');
      setupPlayers();
      selectWordAndCategory();
      assignRoles();
      
      gameState.phase = 'roles';
      gameState.currentPlayer = 0;
      
      showPassDeviceScreen();
      showNotification('Game started! Pass the device around.', 'success');
    }
    
    function setupPlayers() {
      gameState.players = [];
      for (let i = 1; i <= gameState.gameSettings.playerCount; i++) {
        gameState.players.push({
          id: i,
          role: 'innocent',
          alive: true,
          protected: false,
          silenced: false,
          sabotaged: false,
          votedFor: null,
          specialData: {}
        });
      }
    }
    
    function selectWordAndCategory() {
      const categories = Object.keys(currentWordCategories);
      const randomCategory = categories[Math.floor(Math.random() * categories.length)];
      const words = currentWordCategories[randomCategory];
      const randomWord = words[Math.floor(Math.random() * words.length)];
      
      gameState.currentCategory = randomCategory;
      gameState.currentWord = randomWord;
    }
    
    function assignRoles() {
      // Reset all players to innocent first
      gameState.players.forEach(player => {
        player.role = 'innocent';
        player.specialData = {};
      });
      
      // Assign imposters
      const playerIndices = [...Array(gameState.gameSettings.playerCount).keys()];
      shuffleArray(playerIndices);
      
      // Assign imposter roles
      for (let i = 0; i < gameState.gameSettings.imposterCount; i++) {
        gameState.players[playerIndices[i]].role = 'imposter';
      }
      
      // Assign special roles
      let specialRoleIndex = gameState.gameSettings.imposterCount;
      
      // First, assign imposter team roles
      const imposterRoles = Object.entries(gameState.gameSettings.enabledRoles)
        .filter(([roleKey, quantity]) => {
          return roles[roleKey].team === 'imposter' && quantity > 0;
        });
      
      imposterRoles.forEach(([roleKey, quantity]) => {
        for (let i = 0; i < quantity; i++) {
          if (specialRoleIndex < gameState.gameSettings.playerCount) {
            gameState.players[playerIndices[specialRoleIndex]].role = roleKey;
            specialRoleIndex++;
          }
        }
      });
      
      // Then assign innocent team roles
      const innocentRoles = Object.entries(gameState.gameSettings.enabledRoles)
        .filter(([roleKey, quantity]) => {
          return roles[roleKey].team === 'innocent' && quantity > 0;
        });
      
      innocentRoles.forEach(([roleKey, quantity]) => {
        for (let i = 0; i < quantity; i++) {
          if (specialRoleIndex < gameState.gameSettings.playerCount) {
            gameState.players[playerIndices[specialRoleIndex]].role = roleKey;
            specialRoleIndex++;
          }
        }
      });
      
      // Finally assign neutral roles
      const neutralRoles = Object.entries(gameState.gameSettings.enabledRoles)
        .filter(([roleKey, quantity]) => {
          return roles[roleKey].team === 'neutral' && quantity > 0;
        });
      
      neutralRoles.forEach(([roleKey, quantity]) => {
        for (let i = 0; i < quantity; i++) {
          if (specialRoleIndex < gameState.gameSettings.playerCount) {
            gameState.players[playerIndices[specialRoleIndex]].role = roleKey;
            specialRoleIndex++;
          }
        }
      });
      
      // Special role setup
      setupSpecialRoles();
    }
    
    function setupSpecialRoles() {
      gameState.players.forEach(player => {
        switch (player.role) {
          case 'executioner':
            // Assign a random target (not self, not another executioner)
            const possibleTargets = gameState.players.filter(p =>
              p.id !== player.id && p.role !== 'executioner'
            );
            if (possibleTargets.length > 0) {
              player.specialData.target = possibleTargets[Math.floor(Math.random() * possibleTargets.length)].id;
            }
            break;
          case 'lawyer':
            // Assign a client that is on the imposter team
            const imposterClients = gameState.players.filter(p =>
              roles[p.role].team === 'imposter'
            );
            if (imposterClients.length > 0) {
              player.specialData.client = imposterClients[Math.floor(Math.random() * imposterClients.length)].id;
              
              // Let the imposter know who their lawyer is
              const clientPlayer = gameState.players.find(p => p.id === player.specialData.client);
              if (clientPlayer) {
                clientPlayer.specialData.lawyer = player.id;
              }
            }
            break;
          case 'hinter':
            // Generate a hint for the word
            player.specialData.hint = wordHints[gameState.currentWord] || "No hint available for this word";
            break;
        }
      });
    }
    
    // Pass Device Functions
    function showPassDeviceScreen() {
      document.getElementById('setupScreen').style.display = 'none';
      document.getElementById('gameScreen').style.display = 'none';
      document.getElementById('passDeviceScreen').style.display = 'flex';
      
      updatePassDeviceDisplay();
    }
    
    function updatePassDeviceDisplay() {
      const currentPlayerNum = gameState.currentPlayer + 1;
      const totalPlayers = gameState.gameSettings.playerCount;
      
      document.getElementById('passDeviceTitle').textContent = 'Pass Device';
      document.getElementById('passDeviceMessage').innerHTML = 
        `Hand the device to <strong>Player ${currentPlayerNum}</strong> and press continue when ready.<br>
        <small>(${currentPlayerNum} of ${totalPlayers})</small>`;
      
      document.getElementById('countdownDisplay').textContent = '';
      document.getElementById('continueBtn').style.display = 'inline-block';
      document.getElementById('countdownBtn').style.display = 'inline-block';
    }
    
    function showCountdown() {
      let countdown = 5;
      document.getElementById('continueBtn').style.display = 'none';
      document.getElementById('countdownBtn').style.display = 'none';
      
      const countdownInterval = setInterval(() => {
        document.getElementById('countdownDisplay').textContent = countdown;
        
        if (countdown <= 0) {
          clearInterval(countdownInterval);
          continueToRole();
        }
        countdown--;
      }, 1000);
    }
    
    function continueToRole() {
      document.getElementById('passDeviceScreen').style.display = 'none';
      document.getElementById('gameScreen').style.display = 'block';
      
      showPlayerRole();
      playSound('roleReveal');
    }
    
    // Role Display Functions
    function showPlayerRole() {
      const player = gameState.players[gameState.currentPlayer];
      const roleData = roles[player.role];
      
      // Hide voting container during role display
      document.getElementById('votingContainer').classList.add('hidden');
      
      // Show role display
      document.getElementById('roleDisplay').classList.remove('hidden');
      
      document.getElementById('categoryDisplay').textContent = gameState.currentCategory.toUpperCase();
      
      if (roles[player.role].team === 'imposter') {
        document.getElementById('wordDisplay').textContent = '???';
        document.getElementById('wordDisplay').style.color = 'var(--danger-color)';
      } else {
        document.getElementById('wordDisplay').textContent = gameState.currentWord.toUpperCase();
        document.getElementById('wordDisplay').style.color = 'var(--success-color)';
      }
      
      document.getElementById('roleName').textContent = roleData.name.toUpperCase();
      document.getElementById('roleName').className = `role-name ${player.role}`;
      
      let description = roleData.description;
      
      // Add special information for certain roles
      if (player.role === 'executioner' && player.specialData.target) {
        description += `<br><strong>Your Target:</strong> Player ${player.specialData.target}`;
      } else if (player.role === 'lawyer' && player.specialData.client) {
        const clientPlayer = gameState.players.find(p => p.id === player.specialData.client);
        if (clientPlayer) {
          description += `<br><strong>Your Client:</strong> Player ${clientPlayer.id} (${roles[clientPlayer.role].name})`;
        }
      } else if (player.role === 'hinter' && player.specialData.hint) {
        description += `<br><strong>Hint for the word:</strong> ${player.specialData.hint}`;
      }
      
      // Show lawyer information to imposters
      if (player.specialData.lawyer) {
        const lawyerPlayer = gameState.players.find(p => p.id === player.specialData.lawyer);
        if (lawyerPlayer) {
          description += `<br><strong>Your Lawyer:</strong> Player ${lawyerPlayer.id}`;
        }
      }
      
      document.getElementById('roleDescription').innerHTML = description;
      
      // Show special actions if available
      if (roleData.actions && roleData.actions.length > 0) {
        setupSpecialActions(player, roleData.actions);
      } else {
        document.getElementById('specialActions').classList.add('hidden');
      }
      
      // Update phase indicator
      document.getElementById('phaseIndicator').textContent = `Player ${gameState.currentPlayer + 1} - Role Reveal`;
      
      // Animate role display
      const roleDisplay = document.getElementById('roleDisplay');
      roleDisplay.classList.remove('show');
      setTimeout(() => roleDisplay.classList.add('show'), 100);
      
      updatePlayerStatus();
    }
    
    function setupSpecialActions(player, actions) {
      const playerGrid = document.getElementById('playerGrid');
      const actionButtons = document.getElementById('actionButtons');
      playerGrid.innerHTML = '';
      actionButtons.innerHTML = '';
      
      // Set header text
      document.getElementById('actionHeader').textContent = `${roles[player.role].name} Special Actions`;
      
      // Create player buttons for each action
      actions.forEach(action => {
        if (action === 'protect' || action === 'shield' || action === 'moderateDiscussion') {
          // These actions need a player grid
          createPlayerActionGrid(player, action);
        } else {
          // Other actions use regular buttons
          const button = createActionButton(action, player);
          if (button) actionButtons.appendChild(button);
        }
      });
      
      if (playerGrid.children.length > 0 || actionButtons.children.length > 0) {
        document.getElementById('specialActions').classList.remove('hidden');
      } else {
        document.getElementById('specialActions').classList.add('hidden');
      }
    }
    
    function createPlayerActionGrid(player, action) {
      const playerGrid = document.getElementById('playerGrid');
      
      gameState.players.forEach(targetPlayer => {
        if (!targetPlayer.alive) return; // Skip dead players
        
        const playerBtn = document.createElement('button');
        playerBtn.className = 'player-action-btn';
        
        // Set button style based on action
        switch (action) {
          case 'protect':
            playerBtn.className += ' success';
            playerBtn.innerHTML = `
              <span class="player-number">P${targetPlayer.id}</span>
              <span class="player-status">Protect</span>
            `;
            break;
          case 'shield':
            playerBtn.className += ' primary';
            playerBtn.innerHTML = `
              <span class="player-number">P${targetPlayer.id}</span>
              <span class="player-status">Shield</span>
            `;
            break;
          case 'moderateDiscussion':
            playerBtn.className += ' warning';
            playerBtn.innerHTML = `
              <span class="player-number">P${targetPlayer.id}</span>
              <span class="player-status">Speak First</span>
            `;
            break;
        }
        
        // Check if action was already used on this player
        const actionKey = `${player.id}_${action}_${targetPlayer.id}`;
        if (gameState.specialActions[actionKey]) {
          playerBtn.classList.add('used');
          playerBtn.disabled = true;
        }
        
        playerBtn.onclick = () => executePlayerAction(player, targetPlayer, action);
        
        playerGrid.appendChild(playerBtn);
      });
    }
    
    function executePlayerAction(player, targetPlayer, action) {
      const actionKey = `${player.id}_${action}_${targetPlayer.id}`;
      
      if (gameState.specialActions[actionKey]) {
        showNotification('This action has already been used!', 'warning');
        return;
      }
      
      switch (action) {
        case 'protect':
          targetPlayer.protected = true;
          gameState.protectedPlayers.push(targetPlayer.id);
          showNotification(`Player ${targetPlayer.id} is now protected!`, 'success');
          break;
        case 'shield':
          targetPlayer.shielded = true;
          showNotification(`Player ${targetPlayer.id} is now shielded!`, 'success');
          break;
        case 'moderateDiscussion':
          gameState.discussionOrder = gameState.discussionOrder || [];
          gameState.discussionOrder.push(targetPlayer.id);
          showNotification(`Player ${targetPlayer.id} will speak first!`, 'info');
          break;
      }
      
      // Mark action as used
      gameState.specialActions[actionKey] = true;
      
      // Update UI
      setupSpecialActions(player, roles[player.role].actions);
      updatePlayerStatus();
    }
    
    function createActionButton(action, player) {
      const button = document.createElement('button');
      button.className = 'action-btn';
      
      switch (action) {
        case 'observe':
          button.textContent = '👁️ Observe Player';
          button.className += ' purple';
          button.onclick = () => useObserve(player);
          break;
        case 'investigate':
          button.textContent = '🔍 Investigate';
          button.className += ' primary';
          button.onclick = () => useInvestigate(player);
          break;
        case 'heal':
          button.textContent = '⚕️ Heal Player';
          button.className += ' teal';
          button.onclick = () => useHeal(player);
          break;
        case 'silence':
          button.textContent = '🤐 Silence Player';
          button.className += ' danger';
          button.onclick = () => useSilence(player);
          break;
        case 'sabotage':
          button.textContent = '🛠️ Sabotage Player';
          button.className += ' warning';
          button.onclick = () => useSabotage(player);
          break;
        default:
          return null;
      }
      
      // Check if action was already used
      if (gameState.specialActions[`${player.id}_${action}`]) {
        button.disabled = true;
        button.textContent += ' (Used)';
      }
      
      return button;
    }
    
    // Special Action Functions
    function useObserve(player) {
      if (gameState.specialActions[`${player.id}_observe`]) return;
      
      const targetId = prompt('Enter player number to observe (1-' + gameState.gameSettings.playerCount + '):');
      const targetPlayer = gameState.players.find(p => p.id == targetId);
      
      if (!targetPlayer || targetPlayer.id === player.id) {
        showNotification('Invalid target!', 'error');
        return;
      }
      
      const targetRole = roles[targetPlayer.role];
      showNotification(`Player ${targetId} is: ${targetRole.name}`, 'info');
      
      gameState.specialActions[`${player.id}_observe`] = true;
      setupSpecialActions(player, roles[player.role].actions);
    }
    
    function useInvestigate(player) {
      if (gameState.specialActions[`${player.id}_investigate`]) return;
      
      const targetId = prompt('Enter player number to investigate (1-' + gameState.gameSettings.playerCount + '):');
      const targetPlayer = gameState.players.find(p => p.id == targetId);
      
      if (!targetPlayer || targetPlayer.id === player.id) {
        showNotification('Invalid target!', 'error');
        return;
      }
      
      let isSuspicious = false;
      
      // Check if target is on imposter team
      if (roles[targetPlayer.role].team === 'imposter') {
        isSuspicious = true;
      }
      
      const result = isSuspicious ? 'SUSPICIOUS' : 'NOT SUSPICIOUS';
      showNotification(`Player ${targetId} appears: ${result}`, 'warning');
      
      gameState.specialActions[`${player.id}_investigate`] = true;
      setupSpecialActions(player, roles[player.role].actions);
    }
    
    function useHeal(player) {
      if (gameState.specialActions[`${player.id}_heal`]) return;
      
      if (gameState.eliminatedPlayers.length === 0) {
        showNotification('No eliminated players to heal!', 'warning');
        return;
      }
      
      const targetId = prompt('Enter eliminated player number to heal: ' + gameState.eliminatedPlayers.join(', '));
      const targetPlayer = gameState.players.find(p => p.id == targetId);
      
      if (!targetPlayer || !gameState.eliminatedPlayers.includes(parseInt(targetId))) {
        showNotification('Invalid target!', 'error');
        return;
      }
      
      targetPlayer.alive = true;
      gameState.eliminatedPlayers = gameState.eliminatedPlayers.filter(id => id !== parseInt(targetId));
      showNotification(`Player ${targetId} has been healed and returned to the game!`, 'success');
      
      gameState.specialActions[`${player.id}_heal`] = true;
      setupSpecialActions(player, roles[player.role].actions);
    }
    
    function useSilence(player) {
      if (gameState.specialActions[`${player.id}_silence`]) return;
      
      const targetId = prompt('Enter player number to silence (1-' + gameState.gameSettings.playerCount + '):');
      const targetPlayer = gameState.players.find(p => p.id == targetId);
      
      if (!targetPlayer) {
        showNotification('Invalid target!', 'error');
        return;
      }
      
      targetPlayer.silenced = true;
      gameState.silencedPlayers.push(targetPlayer.id);
      showNotification(`Player ${targetId} has been silenced for this round!`, 'warning');
      
      gameState.specialActions[`${player.id}_silence`] = true;
      setupSpecialActions(player, roles[player.role].actions);
    }
    
    function useSabotage(player) {
      if (gameState.specialActions[`${player.id}_sabotage`]) return;
      
      const targetId = prompt('Enter player number to sabotage (1-' + gameState.gameSettings.playerCount + '):');
      const targetPlayer = gameState.players.find(p => p.id == targetId);
      
      if (!targetPlayer) {
        showNotification('Invalid target!', 'error');
        return;
      }
      
      targetPlayer.sabotaged = true;
      gameState.sabotagedPlayers.push(targetPlayer.id);
      showNotification(`Player ${targetId}'s special ability has been blocked for this round!`, 'warning');
      
      gameState.specialActions[`${player.id}_sabotage`] = true;
      setupSpecialActions(player, roles[player.role].actions);
    }
    
    // Game Flow Functions
    function nextPhase() {
      switch (gameState.phase) {
        case 'roles':
          if (gameState.currentPlayer < gameState.gameSettings.playerCount - 1) {
            gameState.currentPlayer++;
            showPassDeviceScreen();
          } else {
            startDiscussionPhase();
          }
          break;
        case 'discussion':
          startVotingPhase();
          break;
        case 'voting':
          processVotingResults();
          break;
        case 'night':
          // Handle night phase actions
          checkWinConditions();
          break;
      }
    }
    
    function startDiscussionPhase() {
      gameState.phase = 'discussion';
      gameState.timeRemaining = gameState.gameSettings.discussionTime * 60;
      
      document.getElementById('phaseIndicator').textContent = 'Discussion Phase';
      
      // Hide role display and voting during discussion
      document.getElementById('roleDisplay').classList.add('hidden');
      document.getElementById('specialActions').classList.add('hidden');
      document.getElementById('votingContainer').classList.add('hidden');
      
      startTimer();
      updatePlayerStatus();
      
      showNotification('Discussion phase started! Talk about the word without saying it directly.', 'info');
      playSound('phaseChange');
    }
    
    function startVotingPhase() {
      gameState.phase = 'voting';
      gameState.selectedVote = null;
      gameState.votingResults = {};
      
      if (gameState.timer) {
        clearInterval(gameState.timer);
      }
      
      document.getElementById('phaseIndicator').textContent = 'Voting Phase';
      
      // Hide the role/word display during voting
      document.getElementById('roleDisplay').classList.add('hidden');
      
      // Show voting container
      document.getElementById('votingContainer').classList.remove('hidden');
      
      setupVotingGrid();
      updatePlayerStatus();
      
      showNotification('Time to vote! Choose who to eliminate.', 'warning');
      playSound('votingStart');
    }
    
    function setupVotingGrid() {
      const votingGrid = document.getElementById('votingGrid');
      votingGrid.innerHTML = '';
      
      // Add all alive players as voting options
      gameState.players.forEach(player => {
        if (player.alive) {
          const voteOption = document.createElement('div');
          voteOption.className = 'vote-option';
          voteOption.textContent = `Player ${player.id}`;
          voteOption.dataset.playerId = player.id;
          
          if (player.silenced) {
            voteOption.classList.add('silenced');
            voteOption.textContent += ' (Silenced)';
          }
          
          voteOption.onclick = () => selectVoteOption(player.id, voteOption);
          votingGrid.appendChild(voteOption);
        }
      });
      
      // Add skip option
      const skipOption = document.createElement('div');
      skipOption.className = 'vote-option';
      skipOption.textContent = 'Skip Vote';
      skipOption.dataset.playerId = 'skip';
      skipOption.onclick = () => selectVoteOption('skip', skipOption);
      votingGrid.appendChild(skipOption);
    }
    
    function selectVoteOption(playerId, element) {
      // Remove previous selection
      document.querySelectorAll('.vote-option').forEach(option => {
        option.classList.remove('selected');
      });
      
      // Select new option
      element.classList.add('selected');
      gameState.selectedVote = playerId;
      
      document.getElementById('submitVoteBtn').disabled = false;
    }
    
    function submitVote() {
      if (!gameState.selectedVote) return;
      
      // Record the vote (in a real game, you'd collect all votes)
      showNotification(`Vote recorded for: ${gameState.selectedVote === 'skip' ? 'Skip' : 'Player ' + gameState.selectedVote}`, 'success');
      // Simulate voting results (in real implementation, collect all player votes)
      processVotingResults();
    }
    
    function skipVote() {
      gameState.selectedVote = 'skip';
      submitVote();
    }
    
    function processVotingResults() {
      if (!gameState.selectedVote) {
        showNotification('No vote selected!', 'error');
        return;
      }
      
      // Simulate vote processing (in reality, you'd collect all votes)
      if (gameState.selectedVote === 'skip') {
        showNotification('Vote skipped! No one was eliminated.', 'info');
      } else {
        const votedPlayer = gameState.players.find(p => p.id == gameState.selectedVote);
        if (votedPlayer && !votedPlayer.protected && !votedPlayer.shielded) {
          eliminatePlayer(votedPlayer.id);
        } else if (votedPlayer && (votedPlayer.protected || votedPlayer.shielded)) {
          showNotification(`Player ${votedPlayer.id} was protected/shielded and cannot be eliminated!`, 'warning');
          votedPlayer.protected = false;
          votedPlayer.shielded = false;
        }
      }
      
      // Reset protection and silence effects
      gameState.protectedPlayers = [];
      gameState.silencedPlayers = [];
      gameState.sabotagedPlayers = [];
      gameState.players.forEach(player => {
        player.protected = false;
        player.silenced = false;
        player.sabotaged = false;
        player.shielded = false;
      });
      
      checkWinConditions();
    }
    
    function eliminatePlayer(playerId) {
      const player = gameState.players.find(p => p.id === playerId);
      if (player) {
        player.alive = false;
        gameState.eliminatedPlayers.push(playerId);
        showNotification(`Player ${playerId} (${roles[player.role].name}) has been eliminated!`, 'danger');
        playSound('elimination');
      }
    }
    
    // Win Condition Functions
    function checkWinConditions() {
      const alivePlayers = gameState.players.filter(p => p.alive);
      const aliveImposters = alivePlayers.filter(p => 
        roles[p.role].team === 'imposter'
      );
      const aliveInnocents = alivePlayers.filter(p => 
        roles[p.role].team === 'innocent'
      );
      
      // Check if jester won (was eliminated)
      const eliminatedJester = gameState.players.find(p => 
        !p.alive && p.role === 'jester'
      );
      if (eliminatedJester) {
        endGame('jester', 'The Jester wins by being eliminated!');
        return;
      }
      
      // Check imposter win condition
      if (aliveImposters.length >= aliveInnocents.length && aliveImposters.length > 0) {
        // Check if there's a lawyer who won with the imposters
        const aliveLawyers = alivePlayers.filter(p => p.role === 'lawyer');
        let lawyerWon = false;
        aliveLawyers.forEach(lawyer => {
          if (lawyer.specialData.client) {
            const client = gameState.players.find(p => p.id === lawyer.specialData.client);
            if (client && client.alive && roles[client.role].team === 'imposter') {
              lawyerWon = true;
            }
          }
        });
        
        if (lawyerWon) {
          endGame('imposters', 'Imposters win! The lawyer successfully defended their client.');
        } else {
          endGame('imposters', 'Imposters outnumber or equal the innocents!');
        }
        return;
      }
      
      // Check innocent win condition
      if (aliveImposters.length === 0) {
        // Check if there's a lawyer who lost with the imposters
        const lawyers = gameState.players.filter(p => p.role === 'lawyer');
        let lawyerLost = false;
        lawyers.forEach(lawyer => {
          if (lawyer.specialData.client) {
            const client = gameState.players.find(p => p.id === lawyer.specialData.client);
            if (client && !client.alive && roles[client.role].team === 'imposter') {
              lawyerLost = true;
            }
          }
        });
        
        if (lawyerLost) {
          endGame('innocents', 'All imposters have been eliminated! The lawyer failed to protect their client.');
        } else {
          endGame('innocents', 'All imposters have been eliminated!');
        }
        return;
      }
      
      // Check executioner win condition
      const executioner = gameState.players.find(p => p.role === 'executioner' && p.alive);
      if (executioner && executioner.specialData.target) {
        const target = gameState.players.find(p => p.id === executioner.specialData.target);
        if (target && !target.alive) {
          endGame('executioner', `The Executioner wins by eliminating Player ${target.id}!`);
          return;
        }
      }
      
      // Continue game if no win conditions met
      if (gameState.phase === 'voting') {
        startDiscussionPhase();
      }
    }
    
    function endGame(winner, message) {
      gameState.phase = 'gameOver';
      
      if (gameState.timer) {
        clearInterval(gameState.timer);
      }
      
      showWinScreen(winner, message);
      playSound('gameEnd');
    }
    
    function showWinScreen(winner, message) {
      const winScreen = document.getElementById('winScreen');
      const winTitle = document.getElementById('winTitle');
      const winMessage = document.getElementById('winMessage');
      const roleRevealList = document.getElementById('roleRevealList');
      
      // Set win title and message
      switch (winner) {
        case 'imposters':
          winTitle.textContent = 'IMPOSTERS WIN!';
          winTitle.style.color = 'var(--danger-color)';
          break;
        case 'innocents':
          winTitle.textContent = 'INNOCENTS WIN!';
          winTitle.style.color = 'var(--success-color)';
          break;
        case 'jester':
          winTitle.textContent = 'JESTER WINS!';
          winTitle.style.color = '#f200ff';
          break;
        case 'executioner':
          winTitle.textContent = 'EXECUTIONER WINS!';
          winTitle.style.color = '#4b0082';
          break;
      }
      
      winMessage.textContent = message;
      
      // Show role reveals
      roleRevealList.innerHTML = '';
      gameState.players.forEach(player => {
        const roleItem = document.createElement('div');
        roleItem.className = 'player-role-item';
        
        if (roles[player.role].team === 'imposter') {
          roleItem.classList.add('imposter');
        } else {
          roleItem.classList.add('innocent');
        }
        
        const playerName = document.createElement('span');
        playerName.textContent = `Player ${player.id}`;
        playerName.style.fontWeight = '600';
        
        const playerRole = document.createElement('span');
        playerRole.textContent = roles[player.role].name;
        playerRole.style.fontWeight = '700';
        playerRole.className = `role-name ${player.role}`;
        
        const playerStatus = document.createElement('span');
        playerStatus.textContent = player.alive ? '✅ Alive' : '💀 Eliminated';
        playerStatus.style.fontSize = '0.9rem';
        
        roleItem.appendChild(playerName);
        roleItem.appendChild(playerRole);
        roleItem.appendChild(playerStatus);
        
        roleRevealList.appendChild(roleItem);
      });
      
      winScreen.style.display = 'flex';
    }
    
    // Timer Functions
    function startTimer() {
      if (gameState.timer) {
        clearInterval(gameState.timer);
      }
      
      gameState.timer = setInterval(() => {
        gameState.timeRemaining--;
        updateTimerDisplay();
        
        if (gameState.timeRemaining <= 0) {
          clearInterval(gameState.timer);
          if (gameState.phase === 'discussion') {
            startVotingPhase();
          }
        }
      }, 1000);
    }
    
    function updateTimerDisplay() {
      const minutes = Math.floor(gameState.timeRemaining / 60);
      const seconds = gameState.timeRemaining % 60;
      document.getElementById('gameTimer').textContent = 
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Player Status Functions
    function updatePlayerStatus() {
      const statusContainer = document.getElementById('playersStatus');
      statusContainer.innerHTML = '';
      
      gameState.players.forEach(player => {
        const playerCard = document.createElement('div');
        playerCard.className = 'player-card';
        
        if (!player.alive) {
          playerCard.classList.add('eliminated');
        }
        if (player.protected) {
          playerCard.classList.add('protected');
        }
        if (player.silenced) {
          playerCard.classList.add('silenced');
        }
        if (player.sabotaged) {
          playerCard.classList.add('sabotaged');
        }
        if (gameState.currentPlayer === player.id - 1 && gameState.phase === 'roles') {
          playerCard.classList.add('current-turn');
        }
        
        const playerNumber = document.createElement('div');
        playerNumber.className = 'player-number';
        playerNumber.textContent = `Player ${player.id}`;
        
        const playerStatus = document.createElement('div');
        playerStatus.className = 'player-status';
        
        let statusText = player.alive ? 'Alive' : 'Eliminated';
        if (player.protected) statusText += ' • Protected';
        if (player.silenced) statusText += ' • Silenced';
        if (player.sabotaged) statusText += ' • Sabotaged';
        if (player.shielded) statusText += ' • Shielded';
        
        playerStatus.textContent = statusText;
        
        playerCard.appendChild(playerNumber);
        playerCard.appendChild(playerStatus);
        statusContainer.appendChild(playerCard);
      });
    }
    
    // Game Reset Functions
    function playAgain() {
      // Reset game state but preserve settings
      resetGameState();
      
      // Hide win screen and show setup screen
      document.getElementById('winScreen').style.display = 'none';
      document.getElementById('setupScreen').style.display = 'block';
      document.getElementById('gameScreen').style.display = 'none';
      document.getElementById('passDeviceScreen').style.display = 'none';
      
      showNotification('Ready for a new game with the same settings!', 'success');
    }
    
    function backToMenu() {
      // Complete reset of all game state including settings
      gameState.gameSettings = {
        playerCount: 5,
        imposterCount: 1,
        discussionTime: 3,
        gameMode: 'classic',
        enabledRoles: {}
      };
      
      // Reset form elements to default values
      document.getElementById('playerCount').value = '5';
      document.getElementById('imposterCount').value = '1';
      document.getElementById('discussionTime').value = '3';
      document.getElementById('gameMode').value = 'classic';
      
      // Reset role quantities to 0
      Object.keys(roles).forEach(roleKey => {
        if (roleKey === 'innocent' || roleKey === 'imposter') return;
        
        const quantityInput = document.getElementById(`${roleKey}Quantity`);
        if (quantityInput) {
          quantityInput.value = '0';
        }
      });
      
      // Update the setup display
      updatePlayerCountOptions();
      updateSetupDisplay();
      
      // Hide win screen and show setup screen
      document.getElementById('winScreen').style.display = 'none';
      document.getElementById('setupScreen').style.display = 'block';
      document.getElementById('gameScreen').style.display = 'none';
      document.getElementById('passDeviceScreen').style.display = 'none';
      
      // Clear any notifications
      clearNotifications();
      
      showNotification('Returned to main menu with default settings.', 'info');
    }
    
    // Utility Functions
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
    
    // Notification System
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      document.getElementById('notificationContainer').appendChild(notification);
      
      setTimeout(() => notification.classList.add('show'), 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    
    function clearNotifications() {
      const container = document.getElementById('notificationContainer');
      container.innerHTML = '';
    }
    
    // Sound System
    function playSound(type) {
      if (!soundEnabled) return;
      
      const visualizer = document.getElementById('soundVisualizer');
      visualizer.classList.add('active');
      setTimeout(() => visualizer.classList.remove('active'), 500);
      
      // In a real implementation, you would play actual sounds here
      // For now, we just show the visual feedback
    }
    
    function toggleSound() {
      soundEnabled = !soundEnabled;
      const soundBtn = document.querySelector('.sound-toggle');
      soundBtn.textContent = soundEnabled ? '🔊 Sound: ON' : '🔇 Sound: OFF';
      
      showNotification(`Sound ${soundEnabled ? 'enabled' : 'disabled'}`, 'info');
    }
    
    // Theme System
    function toggleTheme() {
      currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.body.className = currentTheme + '-mode';
      
      const themeBtn = document.querySelector('.theme-toggle');
      themeBtn.textContent = currentTheme === 'dark' ? '🌙 Dark Mode' : '☀️ Light Mode';
      
      showNotification(`Switched to ${currentTheme} mode`, 'info');
    }
    
    // Event Listeners
    document.getElementById('playerCount').addEventListener('change', updatePlayerCountOptions);
    document.getElementById('imposterCount').addEventListener('change', updateSetupDisplay);
    
    // Initialize the game when page loads
    document.addEventListener('DOMContentLoaded', () => {
      initializeGame();
    });
  </script>
</body>
</html>
